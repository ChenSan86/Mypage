<!DOCTYPE html>
<html class="zyyo.net">
  <head>
    <title>3DæŸ¥çœ‹å™¨ç»„ä»¶ï½œè¾°ç¹–ã®åšå®¢</title>
    <link rel="stylesheet" href="/Mypage/static/css/style.css" />
    <link rel="icon" href="/Mypage/static/img/i6.png" />
    <link rel="stylesheet" href="/Mypage/static/css/rootblur.css" />
    <link rel="stylesheet" href="/Mypage/static/css/blog.css" />
    <style>
        three-container {
            display: block;
            position: relative;
            border: 1px solid var(--surface-color);
            border-radius: 8px;
            overflow: hidden;
            margin: 20px auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 100;
            backdrop-filter: blur(4px);
        }

        .controls-tip {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
  </head>

  <body>
    <div class="zyyo-filter"></div>
    <div class="zyyo-main">
      <div class="zyyo-right blog-detail">
        <div class="breadcrumb">
          <a href="../Project.html" class="breadcrumb-item">
            <svg class="icon" viewBox="0 0 24 24">
              <path
                d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"
              />
            </svg>
            è¿”å›é¡¹ç›®åˆ—è¡¨
          </a>
        </div>
        <article class="article-container">
          <header class="article-header">
            <h1 class="article-title gradientText">
              three-container 3DæŸ¥çœ‹å™¨ç»„ä»¶
            </h1>
          </header>

          <div class="article-content">
            <nav class="toc">
              <h3>ç›®å½•å¯¼èˆª</h3>
              <ul>
                <li><a href="#design-concept">è®¾è®¡ç†å¿µ</a></li>
                <li><a href="#tag-attributes">æ ‡ç­¾å±æ€§è§£æ</a></li>
                <li><a href="#core-features">æ ¸å¿ƒç‰¹æ€§</a></li>
                <li><a href="#code-demo">å®ç°ç¤ºä¾‹</a></li>
                <li><a href="#tech-innovations">æŠ€æœ¯åˆ›æ–°</a></li>
              </ul>
            </nav>

            <section id="design-concept">
              <h2>ä¸€ã€è®¾è®¡ç†å¿µï¼š3Dæ™®åŠåŒ–</h2>
              <div class="point-card">
                <div class="stat-card">
                  <div class="stat-value">83%</div>
                  <div class="stat-label">WebGLåº”ç”¨å¢é•¿ç‡</div>
                </div>
                <div class="point-card">
                  <div class="stat-value">2d to 3dæŠ€æœ¯é«˜é€Ÿå‘å±•</div>
                  <div class="stat-label">gaussian splatting,nerfç­‰æŠ€æœ¯é™ä½äº†3dæ¨¡å‹æ„é€ çš„é—¨æ§›</div>
                </div>
                <div class="point-card">
                  <div class="stat-value">2.7å€</div>
                  <div class="stat-label">3Då†…å®¹è½¬åŒ–ç‡æå‡</div>
                </div>
                <div class="point-card">
                  <div class="stat-value">ä½†æ˜¯ï¼</div>
                  <div class="stat-label">ç›®å‰ç¼ºå°‘ä¸€ä¸ªåƒimage,videoçš„æ ‡ç­¾ç››æ”¾3dæ¨¡å‹</div>
                </div>
              </div>
              <p>ä¼ ç»ŸThree.jså¼€å‘å­˜åœ¨ä¸‰å¤§ç—›ç‚¹ï¼š</p>
              <div class="pain-points">
                <div class="point-card">
                  <h3>ğŸ“¦ ä»£ç å¤æ‚</h3>
                  <p>åˆå§‹åŒ–ä»£ç é‡å¤ç‡é«˜è¾¾62%</p>
                </div>
                <div class="point-card">
                  <h3>ğŸ–±ï¸ äº¤äº’æ€§ä½</h3>
                  <p>äº¤äº’é€»è¾‘éœ€è¦æ‰‹åŠ¨å®ç°</p>
                </div>
                <div class="point-card">
                  <h3>ğŸŒ ä½“é‡è¿‡å¤§</h3>
                  <p>ç¼ºå°‘è½»é‡åŒ–ã€èŒƒç”¨åŒ–çš„3dæ¨¡å‹è¡¨å¾æ ‡ç­¾</p>
                </div>
              </div>

              <p>æœ¬ç»„ä»¶é€šè¿‡Web Componentså®ç°å£°æ˜å¼3Då±•ç¤ºï¼š</p>
              <three-container
                src="./model/treasure.obj"
                mtl="./model/treasure.mtl"
                width="800"
                height="600"
                alt="å®ç®±æ¨¡å‹"
                auto-display="true"
                auto-display-speed="0.005"
                light-position="5,5,5; -5,3,2"
                camera-position="10"
              ></three-container>

              <div>
                ğŸ® æ“ä½œæ§åˆ¶ï¼š<br />
                â€¢ é¼ æ ‡æ‹–æ‹½ï¼šæ—‹è½¬æ¨¡å‹<br />
                â€¢ æ»šè½®ï¼šç¼©æ”¾è§†å›¾<br />
                â€¢ WASD/æ–¹å‘é”®ï¼šç§»åŠ¨è§†è§’<br />
                â€¢ Q/Eï¼šå‡é™é«˜åº¦<br />
                è‡ªåŠ¨æ—‹è½¬ï¼šå¼€å¯/å…³é—­ï¼ˆç”¨æˆ·æ“ä½œæ—¶è‡ªåŠ¨æš‚åœï¼‰<br />
                å…‰æºä½ç½®ï¼šå¯è‡ªå®šä¹‰å¤šä¸ªå…‰æº<br />
                ç›¸æœºä½ç½®ï¼šå¯æŒ‡å®šç»å¯¹åæ ‡ï¼ˆå¦‚â€œ2,3,10â€ï¼‰æˆ–è·ç¦»ï¼ˆå¦‚â€œ10â€ï¼‰
              </div>
            </section>

            <section id="tag-attributes">
              <h2>äºŒã€å±æ€§å‚æ•°è¯¦è§£</h2>
              <div class="attr-table">
                <div class="attr-row header">
                  <span>å±æ€§</span>
                  <span>ç±»å‹</span>
                  <span>é»˜è®¤å€¼</span>
                  <span>è¯´æ˜</span>
                </div>
                <div class="attr-row">
                  <span>src</span>
                  <span>String</span>
                  <span>-</span>
                  <span>æ¨¡å‹æ–‡ä»¶è·¯å¾„ï¼ˆæ”¯æŒ.objæ ¼å¼ï¼‰</span>
                </div>
                <div class="attr-row">
                  <span>mtl</span>
                  <span>String</span>
                  <span>åŒç›®å½•åŒåmtl</span>
                  <span>æè´¨æ–‡ä»¶è·¯å¾„</span>
                </div>
                <div class="attr-row">
                  <span>width</span>
                  <span>Number</span>
                  <span>800</span>
                  <span>ç”»å¸ƒå®½åº¦ï¼ˆåƒç´ ï¼‰</span>
                </div>
                <div class="attr-row">
                  <span>height</span>
                  <span>Number</span>
                  <span>600</span>
                  <span>ç”»å¸ƒé«˜åº¦ï¼ˆåƒç´ ï¼‰</span>
                </div>
                <div class="attr-row">
                  <span>auto-display</span>
                  <span>Boolean</span>
                  <span>false</span>
                  <span>å¯ç”¨è‡ªåŠ¨æ—‹è½¬å±•ç¤º</span>
                </div>
                <div class="attr-row">
                  <span>auto-display-speed</span>
                  <span>Float</span>
                  <span>0.005</span>
                  <span>è‡ªåŠ¨æ—‹è½¬é€Ÿåº¦ï¼ˆå¼§åº¦/å¸§ï¼‰</span>
                </div>
                <div class="attr-row">
                  <span>light-position</span>
                  <span>String</span>
                  <span>"5,5,5"</span>
                  <span>å…‰æºåæ ‡ï¼ˆæ”¯æŒå¤šä¸ªï¼Œåˆ†å·åˆ†éš”ï¼‰</span>
                </div>
                <div class="attr-row">
                  <span>camera-position</span>
                  <span>String</span>
                  <span>è‡ªåŠ¨è®¡ç®—</span>
                  <span>ç›¸æœºåæ ‡ï¼ˆx,y,zæˆ–å•æ•°å­—è·ç¦»ï¼‰</span>
                </div>
                <div class="attr-row">
                  <span>guesture-control</span>
                  <span>Boolean</span>
                  <span>false</span>
                  <span>é›†æˆæ‰‹åŠ¿æ§åˆ¶å‡½æ•°å®ç°äº¤äº’æ–°ä½“éªŒ</span>
                </div>
                
              </div>
              <p>é™æ­¢</p>
              <three-container
                src="./model/treasure.obj"
                mtl="./model/treasure.mtl"
                width="800"
                height="600"
                alt="å®ç®±æ¨¡å‹"
                auto-display="false"
                light-position="5,5,5; -5,3,2"
                camera-position="10"
              ></three-container>
              <p>è°ƒèŠ‚å®¹å™¨å¤§å°</p>
              <three-container
                src="./model/treasure.obj"
                mtl="./model/treasure.mtl"
                width="400"
                height="300"
                alt="å®ç®±æ¨¡å‹"
                auto-display="false"
                light-position="5,5,5; -5,3,2"
                camera-position="10"
              ></three-container>
              <p>è°ƒèŠ‚è½¬åŠ¨é€Ÿåº¦</p>
              <three-container
                src="./model/treasure.obj"
                mtl="./model/treasure.mtl"
                width="400"
                height="300"
                alt="å®ç®±æ¨¡å‹"
                auto-display="true"
                auto-display-speed="0.05"
                light-position="5,5,5; -5,3,2"
                camera-position="10"
              ></three-container>
              <p>è‡ªå®šä¹‰å…‰æº</p>
              <three-container
                src="./model/treasure.obj"
                mtl="./model/treasure.mtl"
                width="800"
                height="600"
                alt="å®ç®±æ¨¡å‹"
                auto-display="false"
                light-position="5,5,5; -5,3,2;9,0,0;0,4,0;0,0,10;7,4,0;,1,6,2;7,3,9"
                camera-position="10"
              ></three-container>
              <p>è‡ªå®šä¹‰ç›¸æœºä½ç½®</p>
              <three-container
                src="./model/treasure.obj"
                mtl="./model/treasure.mtl"
                width="800"
                height="600"
                alt="å®ç®±æ¨¡å‹"
                auto-display="false"
                light-position="5,5,5; -5,3,2"
                camera-position="7,0,0"
              ></three-container>
              <p>å¤šä¸ªæ¨¡å‹æµ‹è¯•</p>
              <three-container
                src="/Mypage/small_task/model/zhaohaisen.obj"
                mtl="/Mypage/small_task/model/zhaohaisen.mtl"
                width="800"
                height="600"
                alt="å®ç®±æ¨¡å‹"
                auto-display="false"
                light-position="5,5,5; -5,3,2"
                camera-position="10"
              ></three-container>
            </section>

            <section id="core-features">
              <h2>ä¸‰ã€ä¸‰å¤§æ ¸å¿ƒç‰¹æ€§</h2>
              <div class="feature-grid">
                <div class="feature-card">
                  <div class="feature-icon">ğŸ”„</div>
                  <h3>æ™ºèƒ½é€‚é…</h3>
                  <p>è‡ªåŠ¨è®¡ç®—æ¨¡å‹å°ºå¯¸å’Œç›¸æœºè·ç¦»</p>
                </div>
                <div class="feature-card">
                  <div class="feature-icon">ğŸ®</div>
                  <h3>å…¨å‘äº¤äº’</h3>
                  <p>æ”¯æŒé¼ æ ‡æ‹–æ‹½+é”®ç›˜æ§åˆ¶</p>
                </div>
                <div class="feature-card">
                  <div class="feature-icon">ğŸ’¾</div>
                  <h3>èµ„æºç®¡ç†</h3>
                  <p>è‡ªåŠ¨æ¸…ç†æè´¨å’Œå‡ ä½•ä½“</p>
                </div>
              </div>
            </section>

            <section id="code-demo">
              <h2>å››ã€å®ç°æ–¹æ¡ˆè§£æ</h2>
              <h3>1. ç»„ä»¶åˆå§‹åŒ–</h3>
              <div class="code-block">
                <pre><code class="language-javascript">
class ThreeContainer extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: 'open' });
    this.initScene();
    this.initElements();
    this.keyState = {};
    this.autoRotate = false;
  }
  
  initScene() {
    // åˆå§‹åŒ–Three.jsæ ¸å¿ƒä¸‰è¦ç´ 
    this.scene = new THREE.Scene();
    this.camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
    this.renderer = new THREE.WebGLRenderer({ 
      antialias: true,
      powerPreference: "high-performance"
    });
  }
}</code></pre>
                <button class="copy-button">å¤åˆ¶</button>
              </div>

              <h3>2. æ™ºèƒ½ç›¸æœºå®šä½</h3>
              <div class="code-block">
                <pre><code class="language-javascript">
adjustCamera() {
  const box = new THREE.Box3().setFromObject(this.model);
  const size = box.getSize(new THREE.Vector3());
  
  // è‡ªåŠ¨è®¡ç®—é»˜è®¤è·ç¦»
  let defaultDistance = size.length() * 2;
  
  // è§£æç”¨æˆ·è‡ªå®šä¹‰è®¾ç½®
  const cameraPos = this.getAttribute('camera-position');
  if (cameraPos) {
    const [x, y, z] = cameraPos.split(',').map(Number);
    if (!isNaN(x)) this.camera.position.set(x, y || x, z || x);
  } else {
    this.camera.position.set(0, 0, defaultDistance);
  }
  
  this.camera.lookAt(this.cameraTarget);
}</code></pre>
                <button class="copy-button">å¤åˆ¶</button>
              </div>
            </section>

            <section id="tech-innovations">
              <h2>äº”ã€æŠ€æœ¯äº®ç‚¹</h2>
              <div class="innovation-grid">
                <div class="innov-card">
                  <h3>ğŸ¯ æ¸è¿›å¼åŠ è½½</h3>
                  <p>æ¨¡å‹ä¸æè´¨å¹¶è¡ŒåŠ è½½+è‡ªåŠ¨é™çº§ç­–ç•¥</p>
                </div>
                <div class="innov-card">
                  <h3>ğŸ”„ æ™ºèƒ½å†…å­˜ç®¡ç†</h3>
                  <p>ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨é‡Šæ”¾GPUèµ„æº</p>
                </div>
                <div class="innov-card">
                  <h3>â±ï¸ èŠ‚æµæ¸²æŸ“</h3>
                  <p>éæ¿€æ´»çŠ¶æ€è‡ªåŠ¨é™å¸§ç‡èŠ‚çœèµ„æº</p>
                </div>
              </div>
            </section>
          </div>

          <div class="article-footer">
            <div class="article-tags">
              <span class="tag">WebGL</span>
              <span class="tag">Three.js</span>
              <span class="tag">Webç»„ä»¶</span>
            </div>
          </div>
        </article>

        <section class="related-articles">
          <h3 class="related-title">å»¶ä¼¸é˜…è¯»</h3>
          <div class="related-grid">
            <a href="https://blog.csdn.net/2401_87362551/article/details/146158267?spm=1001.2014.3001.5501" target="_blank" class="related-item">             
              <h4>å¼€å‘ä¸æµ‹è¯•æ—¥å¿—</h4>
              <p>3æœˆ4æ—¥--3æœˆ8æ—¥</p>
            </a>
          </div>
        </section>
        <section class="related-articles">
          <h3 class="related-title">é¡¹ç›®å±•ç¤º</h3>
          <div class="related-grid">
            <a href="\Mypage\project\core-code\guesture\test2.html" target="_blank" class="related-item">             
              <h4>æ‰‹åŠ¿æ§åˆ¶ç¤ºä¾‹</h4>
              <p>guestureé©±åŠ¨</p>
            </a>
          </div>
        </section>
      </div>
    </div>

    <footer>@ChenSanï½œåšå­¦ä¹‹ï¼Œå®¡é—®ä¹‹ï¼Œæ…æ€ä¹‹ï¼Œæ˜è¾¨ä¹‹ï¼Œç¬ƒè¡Œä¹‹</footer>
  </body>

  <!-- ç»„ä»¶ä¾èµ– -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>

  <!-- ç»„ä»¶å®ç° -->
 <script>
class ThreeContainer extends HTMLElement {
    static get observedAttributes() {
        return ['src', 'mtl', 'width', 'height', 'alt', 'auto-display', 'auto-display-speed', 'light-position', 'camera-position'];
    }

    constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        // æå‰åˆå§‹åŒ–å®šå‘å…‰æ•°ç»„ï¼Œç¡®ä¿ setupLights è°ƒç”¨æ—¶å·²å®šä¹‰
        this.directionalLights = [];
        this.initElements();
        this.initScene();
        this.keyState = {};
        this.cameraTarget = new THREE.Vector3(0, 0, 0);
        // è‡ªåŠ¨æ—‹è½¬ç›¸å…³å˜é‡
        this.autoRotate = false;
        this.autoRotateSpeed = 0.005;
        this.userInteracting = false;
        this.resumeAutoRotateTimer = null;
    }

    initElements() {
        this.loadingElement = document.createElement('div');
        this.loadingElement.className = 'loading-overlay';
        this.loadingElement.innerHTML = `
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
            </svg>
            <div style="margin-top:12px;">åŠ è½½ä¸­...</div>
        `;
        this.shadowRoot.appendChild(this.loadingElement);
    }

    initScene() {
        this.scene = new THREE.Scene();
        this.renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            powerPreference: "high-performance"
        });
        this.renderer.setClearColor(0x000000);
        
        // åˆå§‹åŒ–ç›¸æœº
        this.camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
        // åˆå§‹ä½ç½®å°†åœ¨ adjustCamera ä¸­è®¾ç½®

        // æ·»åŠ ç¯å¢ƒå…‰ï¼ˆå§‹ç»ˆå­˜åœ¨ï¼‰
        const ambient = new THREE.AmbientLight(0xffffff, 0.3);
        this.scene.add(ambient);

        // è®¾ç½®å®šå‘å…‰ï¼ˆå…‰æºä½ç½®å¯è‡ªå®šä¹‰ï¼‰
        this.setupLights();
    }

    setupLights() {
        // ç§»é™¤æ—§çš„å®šå‘å…‰
        this.directionalLights.forEach(light => {
            this.scene.remove(light);
        });
        this.directionalLights = [];

        const lightPosAttr = this.getAttribute('light-position');
        if (lightPosAttr) {
            // æ”¯æŒå¤šä¸ªå…‰æºï¼Œä½¿ç”¨";"åˆ†éš”
            const positions = lightPosAttr.split(';').map(s => s.trim()).filter(s => s);
            positions.forEach(posStr => {
                const coords = posStr.split(',').map(Number);
                if (coords.length >= 3 && coords.every(num => !isNaN(num))) {
                    const directional = new THREE.DirectionalLight(0xffffff, 0.8);
                    directional.position.set(coords[0], coords[1], coords[2]);
                    this.scene.add(directional);
                    this.directionalLights.push(directional);
                }
            });
        } 
        // è‹¥æœªæŒ‡å®šå…‰æºä½ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å…‰æº
        if (this.directionalLights.length === 0) {
            const defaultLight = new THREE.DirectionalLight(0xffffff, 0.8);
            defaultLight.position.set(5, 5, 5);
            this.scene.add(defaultLight);
            this.directionalLights.push(defaultLight);
        }
    }

    connectedCallback() {
        this.updateSize();
        this.shadowRoot.appendChild(this.renderer.domElement);
        this.setupEventListeners();
        this.autoRotate = this.getAttribute('auto-display') === 'true';
        const speedAttr = this.getAttribute('auto-display-speed');
        if (speedAttr) {
            this.autoRotateSpeed = parseFloat(speedAttr);
        }
        this.loadModel();
        this.startRendering();
    }

    attributeChangedCallback(name) {
        if (['width', 'height'].includes(name)) {
            this.updateSize();
        }
        if(name === 'auto-display') {
            this.autoRotate = this.getAttribute('auto-display') === 'true';
        }
        if(name === 'auto-display-speed') {
            const speedAttr = this.getAttribute('auto-display-speed');
            if (speedAttr) {
                this.autoRotateSpeed = parseFloat(speedAttr);
            }
        }
        if(name === 'light-position') {
            this.setupLights();
        }
        if(name === 'camera-position') {
            this.adjustCamera();
        }
    }

    updateSize() {
        const width = parseInt(this.getAttribute('width')) || 800;
        const height = parseInt(this.getAttribute('height')) || 600;
        
        this.style.width = `${width}px`;
        this.style.height = `${height}px`;
        
        this.renderer.setSize(width, height);
        this.camera.aspect = width / height;
        this.camera.updateProjectionMatrix();
    }

    async loadModel() {
        try {
            this.showLoading();
            await this.loadModelData();
            this.processModel();
        } catch (error) {
            this.showError(error ? error.toString() : 'åŠ è½½æ¨¡å‹æ—¶å‡ºé”™');
        } finally {
            this.hideLoading();
        }
    }

    async loadModelData() {
        const src = this.getAttribute('src');
        if (!src) throw new Error('æ¨¡å‹è·¯å¾„æœªæŒ‡å®š');

        if (src.toLowerCase().endsWith('.obj')) {
            await this.loadOBJWithMTL();
        }
    }

    async loadOBJWithMTL() {
        let [objPath, mtlPath] = this.getModelPaths();
        let materials;
        try {
            // å¦‚æœ mtlPath ä¸­å·²ç»åŒ…å«è·¯å¾„ï¼Œåˆ™ç›´æ¥åŠ è½½
            if (mtlPath.includes('/')) {
                materials = await new THREE.MTLLoader().loadAsync(mtlPath);
            } else {
                const basePath = this.getBasePath(objPath);
                materials = await new THREE.MTLLoader().setPath(basePath).loadAsync(mtlPath);
            }
            materials.preload();
        } catch (error) {
            console.warn('ä½¿ç”¨é»˜è®¤æè´¨:', error);
            materials = this.createFallbackMaterial();
        }
        this.model = await new THREE.OBJLoader()
            .setMaterials(materials)
            .loadAsync(objPath);
    }

    getModelPaths() {
        const objSrc = this.getAttribute('src');
        const mtlSrc = this.getAttribute('mtl') || objSrc.replace(/\.obj$/i, '.mtl');
        return [objSrc, mtlSrc];
    }

    getBasePath(filePath) {
        return filePath.substring(0, filePath.lastIndexOf('/') + 1);
    }

    createFallbackMaterial() {
        const material = new THREE.MeshPhongMaterial({
            color: 0x888888,
            specular: 0x111111,
            shininess: 30
        });
        // æ¨¡æ‹Ÿ MTLLoader è¿”å›çš„å¯¹è±¡
        return { create: () => material };
    }

    processModel() {
        this.scene.add(this.model);
        this.centerModel();
        this.adjustCamera();
    }

    centerModel() {
        const box = new THREE.Box3().setFromObject(this.model);
        const center = box.getCenter(new THREE.Vector3());
        this.model.position.sub(center);
        
        const size = box.getSize(new THREE.Vector3());
        const scale = 5 / Math.max(size.x, size.y, size.z);
        this.model.scale.set(scale, scale, scale);
    }

    adjustCamera() {
        // é»˜è®¤è®¡ç®—ï¼šæ ¹æ®æ¨¡å‹åŒ…å›´ç›’è®¾ç½®ç›¸æœºè·ç¦»
        if (!this.model) return;
        const box = new THREE.Box3().setFromObject(this.model);
        const size = box.getSize(new THREE.Vector3());
        let defaultDistance = size.length() * 2;
        
        const cameraPosAttr = this.getAttribute('camera-position');
        if (cameraPosAttr) {
            const parts = cameraPosAttr.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            if (parts.length === 1) {
                this.camera.position.set(0, 0, parts[0]);
            } else if (parts.length >= 3) {
                this.camera.position.set(parts[0], parts[1], parts[2]);
            } else {
                this.camera.position.set(0, 0, defaultDistance);
            }
        } else {
            this.camera.position.set(0, 0, defaultDistance);
        }
        this.camera.lookAt(this.cameraTarget);
        this.camera.updateProjectionMatrix();
    }

    setupEventListeners() {
        // é¼ æ ‡æ‹–æ‹½
        let isDragging = false;
        let prevX = 0, prevY = 0;

        const onMouseDown = e => {
            isDragging = true;
            prevX = e.clientX;
            prevY = e.clientY;
            this.pauseAutoRotate();
        };

        const onMouseMove = e => {
            if (!isDragging || !this.model) return;
            
            const deltaX = e.clientX - prevX;
            const deltaY = e.clientY - prevY;
            
            this.model.rotation.y += deltaX * 0.005;
            this.model.rotation.x += deltaY * 0.005;
            prevX = e.clientX;
            prevY = e.clientY;
        };

        const onMouseUp = () => {
            isDragging = false;
            this.resumeAutoRotateAfterDelay();
        };

        this.addEventListener('mousedown', onMouseDown);
        this.addEventListener('mousemove', onMouseMove);
        this.addEventListener('mouseup', onMouseUp);
        this.addEventListener('mouseleave', onMouseUp);

        // æ»šè½®ç¼©æ”¾
        this.addEventListener('wheel', e => {
            e.preventDefault();
            this.pauseAutoRotate();
            const delta = e.deltaY * 0.002;
            this.camera.translateZ(delta * 15);
            this.camera.lookAt(this.cameraTarget);
            this.resumeAutoRotateAfterDelay();
        }, { passive: false });

        // ä¿å­˜é”®ç›˜äº‹ä»¶å›è°ƒå¼•ç”¨
        this._onKeyDown = (e) => {
            this.keyState[e.key.toLowerCase()] = true;
            this.pauseAutoRotate();
        };
        this._onKeyUp = (e) => {
            this.keyState[e.key.toLowerCase()] = false;
            this.resumeAutoRotateAfterDelay();
        };
        window.addEventListener('keydown', this._onKeyDown);
        window.addEventListener('keyup', this._onKeyUp);
    }

    pauseAutoRotate() {
        this.userInteracting = true;
        if (this.resumeAutoRotateTimer) {
            clearTimeout(this.resumeAutoRotateTimer);
            this.resumeAutoRotateTimer = null;
        }
    }

    resumeAutoRotateAfterDelay() {
        // è‹¥è‡ªåŠ¨æ—‹è½¬å¼€å¯ï¼Œåˆ™åœ¨1ç§’æ— æ“ä½œåæ¢å¤
        if (!this.autoRotate) return;
        if (this.resumeAutoRotateTimer) clearTimeout(this.resumeAutoRotateTimer);
        this.resumeAutoRotateTimer = setTimeout(() => {
            this.userInteracting = false;
        }, 1000);
    }

    handleCameraMovement() {
        const baseSpeed = 0.15;
        const speed = this.keyState.shift ? baseSpeed * 2 : baseSpeed;

        // å‰åç§»åŠ¨
        if (this.keyState.w || this.keyState.arrowup) {
            this.camera.translateZ(-speed);
        }
        if (this.keyState.s || this.keyState.arrowdown) {
            this.camera.translateZ(speed);
        }

        // å·¦å³ç§»åŠ¨
        if (this.keyState.a || this.keyState.arrowleft) {
            this.camera.translateX(-speed);
        }
        if (this.keyState.d || this.keyState.arrowright) {
            this.camera.translateX(speed);
        }

        // å‡é™æ§åˆ¶
        if (this.keyState.q) this.camera.position.y += speed;
        if (this.keyState.e) this.camera.position.y -= speed;

        this.camera.lookAt(this.cameraTarget);
    }

    startRendering() {
        const animate = () => {
            requestAnimationFrame(animate);
            this.handleCameraMovement();
            // è‡ªåŠ¨æ—‹è½¬ï¼šåªæœ‰åœ¨å¼€å¯è‡ªåŠ¨æ—‹è½¬ä¸”ç”¨æˆ·æ²¡æœ‰äº¤äº’çš„æƒ…å†µä¸‹æ‰æ‰§è¡Œ
            if (this.autoRotate && !this.userInteracting && this.model) {
                this.model.rotation.y += this.autoRotateSpeed;
            }
            this.renderer.render(this.scene, this.camera);
        };
        animate();
    }

    showLoading() {
        this.loadingElement.style.display = 'flex';
    }

    hideLoading() {
        this.loadingElement.style.display = 'none';
    }

    showError(message) {
        this.loadingElement.innerHTML = `
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2">
                <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div style="color:#ff4444; margin-top:12px;">${message}</div>
        `;
    }

    disconnectedCallback() {
        window.removeEventListener('keydown', this._onKeyDown);
        window.removeEventListener('keyup', this._onKeyUp);
        this.renderer.dispose();
        
        if (this.model) {
            this.model.traverse(child => {
                if (child.material) child.material.dispose();
                if (child.geometry) child.geometry.dispose();
            });
        }
    }
}

customElements.define('three-container', ThreeContainer);
</script>
</html>
